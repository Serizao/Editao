<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Editao</title>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="node_modules/highlight.js/styles/atom-one-dark.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script>window.$ = window.jQuery = require('jquery');</script>
  </head>
  <body onload="onLoad()">
    <input type="hidden" id="paramPreview" value="true">
    <input type="hidden" id="bottomHidden" value="true">
    <input type="hidden" id="leftHidden" value="true">
    <input type="hidden" id="emplacement" value="true">
    <input type="hidden" id="path" value="">
    <div id="display"></div>
    <div class="container no-margin">
      <div id="expandSideMenu" class=""><a href="#"> > </a></div>
      <div class="row f-height no-margin">
        <div class="editorSide col-md-6">
          <textarea class="editor" id="editor" onkeyup="generatePreview()" onchange="generatePreview()"></textarea>
        </div>
        <div id="preview" class="previewSide col-md-6">

        </div>

      </div>
    </div>

    <div id="bottom-bar"  class="row bottom-bar">

      <div class="dropup">
        <button class="btn btn-link btn-sm dropdown-toggle"   title="Les titres" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Titre
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a class="dropdown-item" onclick="insertB('# ')" href="#">Titre 1</a>
          <a class="dropdown-item" onclick="insertB('## ')" href="#">Titre 2</a>
          <a class="dropdown-item" onclick="insertB('### ')" href="#">Titre 3</a>
          <a class="dropdown-item" onclick="insertB('#### ')" href="#">Titre 4</a>
          <a class="dropdown-item" onclick="insertB('##### ')" href="#">Titre 5</a>
          <a class="dropdown-item" onclick="insertB('###### ')" href="#">Titre 6</a>
        </div>
      </div>
      <button class="btn btn-link btn-sm" onclick="insertBoth('*','*','Italic')"><i>Italic</i></button>
      <button class="btn btn-link btn-sm" onclick="insertBoth('**','**','Gras')"><b>Gras</b></button>
      <button class="btn btn-link btn-sm" onclick="insertBoth('~~','~~','Barré')"><s>Barré</s></button>
      <button class="btn btn-link btn-sm" onclick="souligne()"><u>Souligné</u></button>
      <button class="btn btn-link btn-sm"  onclick="insertBoth('^','^','e')">e<sup>x</sup></button>
      <button class="btn btn-link btn-sm" onclick="insertBoth('~','~','e')">e<sub>x</sub></button>
      <div class="dropup">
        <button class="btn btn-link btn-sm dropdown-toggle"  title="Les listes" type="button" id="dropdownMenuButton2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fa fa-list-ul"></i>
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
          <a class="dropdown-item" onclick="insertB('- ')" href="#">Liste</a>
          <a class="dropdown-item" onclick="insertB('1. ')" href="#">Liste ordonée</a>
          <a class="dropdown-item" onclick="insertB('- [ ] ')" href="#">Liste de tâches</a>
          <a class="dropdown-item" onclick="insertB('1. [ ] ')" href="#">Liste de tâches ordonnées</a>
        </div>
      </div>
      <div class="dropup">
        <button class="btn btn-link btn-sm dropdown-toggle" title="Les flèches" type="button" id="dropdownMenuButton3" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fa fa-arrow-right"></i>
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
          <a class="dropdown-item" onclick="insertB('--> ')" href="#"> → </a>
          <a class="dropdown-item" onclick="insertB('<--> ')" href="#"> ↔ </a>
          <a class="dropdown-item" onclick="insertB('==> ')" href="#"> ⇒ </a>
          <a class="dropdown-item" onclick="insertB('<==> ')" href="#"> ⇔ </a>
        </div>
      </div>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Ajouter une case à cocher" onclick="insertB('[ ] ')"><i class="fa fa-check-square"></i></button>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Ajouter une image" onclick="insertA('![A cat](/files/cat.jpg=100x) ')"onclick="picture()"><i class="fa fa-picture-o"></i></button>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Ajouter un sommaire automatique" onclick="insertA('${toc}')"><i class="fa fa-list-ol"></i></button>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Ajouter un tableau" onclick="insertA('| Tables   |      Are      |  Cool | \n|----------|:-------------:|------:|\n| col 1 is |  left-aligned | $1600 |\n| col 2 is |    centered   |   $12 |\n| col 3 is | right-aligned |    $1 |')">Tableau</button>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Ajouter un lien" onclick="insertA('[nom du lien](http://)')"><i class="fa fa-link"></i></button>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Ajouter une citation" onclick="insertB('> ')"><i class="fa fa-quote-left"></i></button>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Ajouter un schéma UML" onclick="insertA('@startuml\nbob->toto\nbob -->toto\ntoto --X bob\n@enduml')">UML Schéma</button>
      <div class="dropup">
        <button class="btn btn-link btn-sm dropdown-toggle" title="Exporter le document"  type="button" id="dropdownMenuButton3" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fa fa-upload"></i>
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
          <a class="dropdown-item"  onclick="saveAsDocx()" href="#"> Exporter en .docx </a>
          <a class="dropdown-item" onclick="saveAsPdf()" href="#"> Export en .pdf </a>
        </div>
      </div>
      <button class="btn btn-link btn-sm" data-toggle="tooltip" data-placement="top" title="Sauvegarder" onclick="saveAsMd()"><i class="fa fa-save"></i></button>

      <button class="btn btn-outline-primary btn-sm" id="previewButton" data-toggle="tooltip" data-placement="top" title="Activer/Désactiver la prévisulisation" onclick="hidePreview()"><i class="fa fa-columns"></i></button>

    </div>

    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
      window.jQuery = window.$ = require('jquery');
    </script>
    <script src="node_modules/popper.js/dist/umd/popper.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
    <script src="node_modules/html-docx-js/dist/html-docx.js"></script>

    <script>
    const ipc = require('electron').ipcRenderer
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })
    var timeout;
    function generatePreview() {
        var emoji = require('markdown-it-emoji');
        var footnote = require('markdown-it-footnote');
        var emoji = require('markdown-it-emoji');
        var sub = require('markdown-it-sub');
        var sup = require('markdown-it-sup');
        var check = require('markdown-it-checkbox');
        var imsize = require('markdown-it-imsize');
        var md = require('markdown-it')({
          html:         false,        // Enable HTML tags in source
          xhtmlOut:     false,        // Use '/' to close single tags (<br />).                          // This is only for full CommonMark compatibility.
          breaks:       false,        // Convert '\n' in paragraphs into <br>
          langPrefix:   'hljs language-',  // CSS language prefix for fenced blocks. Can be                        // useful for external highlighters.
          linkify:      true,        // Autoconvert URL-like text to links
          typographer:  true,
          quotes: '“”‘’',
          highlight: function (code){ return require('highlight.js').highlightAuto(code).value;}
        }).use(footnote).use( require("markdown-it-anchor"), { permalink: true, permalinkBefore: true, permalinkSymbol: '' } )
          .use( require("markdown-it-toc-done-right"))
          .use(emoji)
          .use(sub)
          .use(sup)
          .use(check)
          .use(imsize)
          .use(require('markdown-it-multimd-table'))
          .use(require('markdown-it-plantuml'))
          .use(require('markdown-it-smartarrows'));


        var editor = document.getElementById('editor').value;
      //  katex.renderToString(editor,)
        document.getElementById('preview').innerHTML= md.render(editor);
    }
function hidePreview(){
  var val = document.getElementById('paramPreview').value;
  if(val == "true" ){
    document.getElementById('paramPreview').value = false;
    document.getElementById('preview').style.display='none';
    $('.editorSide').removeClass('col-md-6');
    $('.editorSide').addClass('col-md-12');
    $('#previewButton').removeClass('btn-outline-primary')
    $('#previewButton').addClass('btn-link')
  } else {
    document.getElementById('paramPreview').value = true;
    document.getElementById('preview').style.display='block';
    $('.editorSide').removeClass('col-md-12');
    $('.editorSide').addClass('col-md-6');
    $('#previewButton').addClass('btn-outline-primary')
    $('#previewButton').removeClass('btn-link')
  }
}
function insertB(insert){
  var cursorPos = $('#editor').prop('selectionStart');
  var v = $('#editor').val()
  var textBefore = v.substring(0,  cursorPos );
  var textAfter  = v.substring( cursorPos, v.length );
  $('#editor').val( textBefore+ insert +textAfter );
  generatePreview()
}

function insertA(insert){
  var cursorPos = $('#editor').prop('selectionEnd');
  var v = $('#editor').val();
  var textBefore = v.substring(0,  cursorPos );
  var textAfter  = v.substring( cursorPos, v.length );
  $('#editor').val( textBefore+ insert +textAfter );
  generatePreview()
}
function insertBoth(before,after, ex=''){
  var cursorPosStart = $('#editor').prop('selectionStart');
  var cursorPosEnd = $('#editor').prop('selectionEnd');
  if(cursorPosEnd == cursorPosStart){
    before = before + ex;
  }
  var v1 = $('#editor').val()
  var textBeforeStart = v1.substring(0,  cursorPosStart );
  var textAfterStart  = v1.substring( cursorPosStart, v1.length );
  $('#editor').val( textBeforeStart+ before +textAfterStart );
  var v2 = textBeforeStart+ before +textAfterStart ;
  var textBeforeEnd = v2.substring(0,  cursorPosEnd+before.length );
  var textAfterEnd  = v2.substring( cursorPosEnd+before.length , v2.length);
  $('#editor').val( textBeforeEnd+ after +textAfterEnd );

  generatePreview();
}
function mouse(p){
  var element1 = document.getElementById("expandSideMenu");
  var element2 = document.getElementById('bottom-bar');
  element1.classList.remove("expandSideMenuTransition");
  element2.classList.remove("bottomBarTransition");
}
setTimeout(function () {

}, 10);
function onLoad(){
  setInterval(hideMenu, 6000);
  addEventListener('mousemove', mouse, false);
}
function hideMenu(){
  $('#expandSideMenu').addClass('expandSideMenuTransition');
  $('.bottom-bar').addClass('bottomBarTransition');
}
function saveAsPdf2(content){
  const ipc = require('electron').ipcRenderer
  ipc.send("printPDF", content);
}
function saveAsPdf(){
  saveAsPdf2($('#preview').html())
}
function saveAsDocx(){
  const ipc = require('electron').ipcRenderer
  ipc.send("readyToPrintDOC", $('#preview').html());
}
function saveAsMd(){
  const ipc = require('electron').ipcRenderer
  var path = $('#path').val()
  if(path==''){
    ipc.send("saveAsMd", $('#editor').val());
  } else {
    ipc.send("saveMd", $('#editor').val(),path);
  }
}
ipc.on('wrote-md', function (event, path) {
  $('#path').val(path);
  display('success',' Votre fichier a bien été sauvegardé')
})
ipc.on('wrote-pdf', function (event, path) {
  $('#path').val(path);
  display('success',' Votre fichier a bien été sauvegardé')
})
ipc.on('wrote-doc', function (event, path) {
  $('#path').val(path);
  display('success',' Votre fichier a bien été sauvegardé')
})
function display(state,msg,time=true){
  add='';
  if(state=='success'){
      type = "alert-success";
      title='Succès';
  }
  if(state=='error'){
      type = "alert-danger";
      title='Erreur';
  }
  if(state=='info'){
      type = "alert-info";
      title='Info';
  }
  if(state=='warning'){
      type = "alert-warning";
      title='Attention';
  }

  html= '<div class="alert '+type+'" role="alert"> \
         <button type="button" class="close" data-dismiss="alert" aria-label="Close"> \
            <span aria-hidden="true">&times;</span>\
         </button>\
          <p>'+msg+'</p>\
      </div>'+add;
      $('#display').html(html);

      if(time){
        $("."+type).fadeTo(2000, 500).slideUp(500, function(){    $("."+type).slideUp(500);   });
      }
}
   </script>

  </body>
</html>
